<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Test framework - Conflux Documentation</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Test framework";
    var mkdocs_page_input_path = "test_framework.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Conflux Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Welcome to Conflux</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../install/">Installation</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../get_started/">Getting Started</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../setup_independent_chain/">Run an Indepdent Chain</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../json-rpc/">JSON-RPC API</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../javascript-api/">JavaScript API</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cli/">CLI Sub-commands</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../design/">Design & Implementation</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../send_transaction/">My First Transaction</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Conflux Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Test framework</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="test-framework">Test Framework<a class="headerlink" href="#test-framework" title="Permanent link">&para;</a></h1>
<p>The framework is written in <code>python3</code>. It can setup multiple Conflux nodes and test the distributed system behavior locally. It controls the nodes behavior by setting the node configurations, calling their RPCs, or sending them P2P messages directly.</p>
<p>All related files are included in the directory  <code>tests</code>. </p>
<p>After compiling the source code with <code>cargo build --release</code> under the project directory, you can run <code>tests/test_all.py</code> to run all included python tests.</p>
<h2 id="an-example-test">An Example Test<a class="headerlink" href="#an-example-test" title="Permanent link">&para;</a></h2>
<p>Here is an example test. It setups 2 nodes, makes each node generate some blocks separately, and finally connects them to check if they can receive the blocks generated by the other.</p>
<pre><code class="python">from test_framework.test_framework import ConfluxTestFramework
from test_framework.util import *

class ExampleTest(ConfluxTestFramework):
    def set_test_params(self):
        self.setup_clean_chain = True
        self.num_nodes = 2

    def setup_network(self):
        self.setup_nodes()
        # connect_sample_nodes(self.nodes, self.log)

    def run_test(self):
        self.nodes[0].generate(1, 0)
        assert (self.nodes[0].getblockcount() == 2)

        self.nodes[1].generate(2, 0)
        assert (self.nodes[1].getblockcount() == 3)

        connect_nodes(self.nodes, 0, 1)
        sync_blocks(self.nodes)
        assert (self.nodes[0].getblockcount() == 4)
        self.log.info(&quot;PASS&quot;)

if __name__ == '__main__':
    ExampleTest().main()
</code></pre>

<p>The framework will</p>
<ol>
<li>Call <code>set_test_params</code> to set basic test initialization parameters.</li>
<li>Setup the test directories and node configurations according to the parameters set in <code>set_test_params</code>. By default, a temp directory will be created and all files will be kept within it. For example, setting <code>self.num_nodes = 2</code> will initialize directories for two nodes.</li>
<li>Call <code>setup_network</code> to add nodes and connect them. Here <code>self.setup_nodes()</code> will add 2 Conflux nodes by running pre-compiled Conflux executable binary within the directory setupped in step 2. We do not connect them here because we want nodes seperated at the beginning.</li>
<li>Call <code>run_test</code> to run the actual test codes.</li>
</ol>
<p>After running <code>self.setup_nodes()</code>, <code>self.nodes</code> is a list of <code>TestNode</code>, and each can be used to interact with the corresponding Conflux node. For example, to get the number of blocks in node 0 by calling the RPC named <code>getblockcount</code>, you simply call <code>self.nodes[0].getblockcount</code> and an integer will be returned.</p>
<p><code>connect_nodes(self.nodes, 0, 1)</code> connects nodes 0 and 1. <code>sync_blocks(self.nodes)</code> waits until all nodes have the same pivot chain tip. Them are both implemented by calling RPCs, and more useful functions will be introduced in [Utility Function List][#utility-function-list].</p>
<h2 id="sending-p2p-messages">Sending P2P Messages<a class="headerlink" href="#sending-p2p-messages" title="Permanent link">&para;</a></h2>
<p>After calling <code>start_p2p_connection(self.nodes)</code>, the field <code>p2p</code> of each <code>TestNode</code> will be initialized with a simulated Conflux node written in Python, and this simulated node will be connected to the Conflux process controled by the corresponding <code>TestNode</code>. After that, you can send and receive P2P messages within python code. Here is an example about how to use <code>p2p</code> to interact with the Conflux node.</p>
<pre><code class="python">    def run_test(self):
        def assert_length(_node, msg):
            assert_equal(len(msg.headers), 1)
        h = WaitHandler(self.nodes[0].p2p, GET_BLOCK_HEADERS_RESPONSE, assert_length)
        self.nodes[0].p2p.send_protocol_msg(GetBlockHeaders(hashes=[self.nodes[0].p2p.genesis.hash]))
        h.wait()
</code></pre>

<p>This example tries to get the genesis block header from node 0 with P2P requests (instead of using RPC), and asserts that only one header is returned.</p>
<p><code>WaitHandler</code> will wait for the first message of the designated message type and run a function on this received message. <code>p2p.send_protocol_msg</code> is used to send a rlp-encodable message. <code>h.wait()</code> waits and handles the first received <code>GET_BLOCK_HEADERS_RESPONSE</code> message. Note that <code>WaitHandler</code> starts listening right after it's initialized.</p>
<h2 id="configurations">Configurations<a class="headerlink" href="#configurations" title="Permanent link">&para;</a></h2>
<p>By default, tests will use the release version executable binary built by <code>cargo</code>. If you want to use a file at another path (e.g., a debug version binary), you can set the environment variable <code>CONFLUX</code> to the full path of the used binary file before running the tests.</p>
<p>TODO</p>
<h2 id="utility-function-list">Utility Function List<a class="headerlink" href="#utility-function-list" title="Permanent link">&para;</a></h2>
<p>TODO</p>
<h2 id="introduction-to-existing-python-tests">Introduction to Existing Python Tests<a class="headerlink" href="#introduction-to-existing-python-tests" title="Permanent link">&para;</a></h2>
<p>TODO</p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright Â© 2019 Conflux. All Rights Reserved.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
